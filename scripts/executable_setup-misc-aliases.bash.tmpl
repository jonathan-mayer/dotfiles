#! /bin/bash

# Update Alias
{{- if eq .chezmoi.osRelease.id "arch" }}
alias update="sudo pacman -Syu --noconfirm && yay -Syu --rebuildall --noconfirm && brew upgrade && flatpak update -y"
{{- else if eq .chezmoi.osRelease.id "fedora" }}
alias update="sudo dnf upgrade --refresh -y && brew upgrade && flatpak update -y"
{{- else }}
alias update="sudo apt update && sudo apt upgrade -y && brew upgrade"
{{- end }}

# Pre-Commit Aliases
alias pci="pre-commit install" \
    pcu="pre-commit uninstall" \
    pc="pre-commit" \
    pcr="pre-commit run --all-files"

# Lines Changed Aliases
alias lines-changed="git diff --stat main --cached -- . ':(exclude)**/package-lock.json'"
alias lines-staged="git diff --stat HEAD --cached -- . ':(exclude)**/package-lock.json'"
alias lines-total="git ls-files --others --exclude-standard --cached -z | grep -zv 'package\.json\|package-lock\.json' | xargs -0 wc -l"
alias lines-total-go="find . -name '*' -type f | grep -e '\.go$' | grep -ve '_test\.go$' | xargs wc -l"

# Dotenv Alias
dotenv() {
    local env_file="${1:-.env}"
    if [[ -f "$env_file" ]]; then
        export $(grep -v ^# "$env_file" | xargs)
    else
        echo "File $env_file not found!"
    fi
}

# Kubernetes Context Alias
ctx() {
    if [ $# -eq 0 ]; then # command was run without arguments
        kubectl config current-context 2>/dev/null
        kubectl config get-contexts
    elif [ -z "$1" ]; then
        kubectl config unset current-context
    else
        kubectl config use-context "$1"
    fi
}
_ctx() {
  [[ $COMP_CWORD -eq 1 ]] &&
    COMPREPLY=( $(compgen -W "$(kubectl config get-contexts -o name)" -- "${COMP_WORDS[1]}") )
}
complete -F _ctx ctx

# ls Aliases
alias ll="ls -alF"
alias la="ls -A"

# kubectl alias
alias k=kubectl

# btop alias
alias htop="echo use btop instead"

# delete empty directories
alias delete-empty-dirs="find . -type d -empty -delete"

# open in browser
browser() {
    local opener="${BROWSER:-xdg-open}"
    echo "Opening: $1"
    "$opener" "$1" >/dev/null 2>&1
}

# git goto main
alias gitmain="git fetch origin main:main && git checkout main && delete-local-refs"

# git open repo in browser
gitopen() {
    local dir="${1:-.}"
    
    # Verify it's a git repository
    if [[ ! -d "$dir/.git" ]]; then
        echo "Error: '$dir' is not a git repository." >&2
        return 1
    fi

    # Save current directory and switch to target
    local orig_dir="$(pwd)"
    cd "$dir" || return 1

    # normalize repo url
    local repo_url
    repo_url=$(git remote get-url origin)

    # normalize ssh (with and without protocol) and http urls
    if [[ "$repo_url" =~ ^ssh://git@(.+)\.git$ ]]; then
        repo_url="https://${BASH_REMATCH[1]}"
    elif [[ "$repo_url" =~ ^git@([^:]+):(.+)\.git$ ]]; then
        repo_url="https://${BASH_REMATCH[1]}/${BASH_REMATCH[2]}"
    elif [[ "$repo_url" =~ ^https://.+\.git$ ]]; then
        repo_url="${repo_url%.git}"
    fi

    # Open Repo in browser
    browser "$repo_url"

    # return to original directory
    cd "$orig_dir"
}
complete -d gitopen

# git branch and commit
gitcb() {
    local message="$*" # something like "fix: something again"

    if [[ -z "$message" ]]; then
        echo "Usage: gitcb \"<commit message>\""
        return 1
    fi

    # check if user is not currently on main
    local current_branch
    current_branch=$(git symbolic-ref --short HEAD 2>/dev/null)

    if [[ "$current_branch" != "main" && "$current_branch" != "master" ]]; then
        echo "You are currently on branch: $current_branch."
        echo "Typically you use this command (git commit and branch) for a single commit change that requires branching."
        echo "If this wasn't intentional you might want to checkout main using 'gitmain'."
        read -rp "Continue creating a new branch from here? [y/N] " confirm
        case "$confirm" in
            [yY][eE][sS]|[yY]) ;;
            *) echo "Aborted."; return 1 ;;
        esac
    fi

    # convert message to "fix/something-again" for branch
    # logic:
    #   sed: try converting ": " to "/" or keep original string
    #   tr: replace " " with "-"
    #   tr: convert to lowercase
    local branch=$(echo "$message" | sed -E 's/^([a-z]+):[[:space:]]*(.*)$/\1\/\2/' | tr ' ' '-' | tr '[:upper:]' '[:lower:]') 

    git switch -c "$branch"
    git add .
    git commit -nm "$message"
    git push -u origin "$branch"

    gitopen
}
_gitcb() {
  [[ $COMP_CWORD -eq 1 ]] &&
    COMPREPLY=( $(compgen -W "feat: chore: revert: fix: refactor: test: docs: style: perf:" -- "${COMP_WORDS[1]}") )
}
complete -F _gitcb gitcb
